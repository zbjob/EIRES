# -*- coding: utf-8 -*-
"""gge.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1pMPzuGhgzau-MBYzIwLeB3zHGXfi3tGY
"""

# !pip install geopandas

import ee
import pandas as pd
import numpy as np 
import geopandas as gpd
from shapely.geometry import Point, Polygon, MultiPolygon

# read latitude and longitude
lats = pd.read_csv('./drive/My Drive/Griffith1/californiaC01_201811080000_lats.csv',header=None)
lons = pd.read_csv('./drive/My Drive/Griffith1/californiaC01_201811080000_lons.csv',header=None)

rect = []
rect.append([lons.iloc[0][0],lats.iloc[0][0]])
rect.append([lons.iloc[lons.shape[0]-1][0],lats.iloc[lats.shape[0]-1][0]])
rect.append([lons.iloc[lons.shape[0]-1][lons.shape[1]-1],lats.iloc[lats.shape[0]-1][lats.shape[1]-1]])
rect.append([lons.iloc[0][lons.shape[1]-1],lats.iloc[0][lats.shape[1]-1]])
print(rect)

ee.Authenticate()

ee.Initialize()

bounds = ee.Geometry.Polygon(rect)

modis = ee.ImageCollection("MODIS/006/MCD12Q1").filterDate('2018-01-01', '2018-01-15')
modis = modis.toList(modis.size())

img = ee.Image(modis.get(0)).select('LC_Type1').clip(bounds);

categories = {'forest' : [1,2,3,4,5],'shrub':[6,7],'croplands':[12,14],'grassland':[10]}
labels = []
boundaries = []
for c in categories:
  labels.append(c)
  landcover = img.eq(categories[c][0])
  for i in categories[c]:
    landcover = landcover if (i==categories[c][0]) else landcover.add(img.eq(i))
    landcover = landcover.updateMask(landcover)
  vectors = landcover.addBands(img).reduceToVectors(geometry=bounds,crs= img.projection(),scale=1000,geometryType= 'polygon',eightConnected=False,labelProperty='class',reducer=ee.Reducer.mean())
  coordinates = vectors.geometry().getInfo()['coordinates']
  polygons = []
  for coord in coordinates:
    polygons.append(Polygon(coord[0]))
  boundaries.append(MultiPolygon(polygons))
  print(c,len(coordinates))
df = pd.DataFrame({'label':labels,'boundary':boundaries})
gdf =gpd.GeoDataFrame(df,geometry='boundary')
gdf.to_csv('./drive/My Drive/Griffith/CEP/landcover.csv',index=False)